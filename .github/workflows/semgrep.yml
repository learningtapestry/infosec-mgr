name: Semgrep Security Scan

on:
  workflow_call:
    inputs:
      product_name:
        description: 'Product name in DefectDojo (defaults to repository name)'
        required: false
        type: string
        default: ''
      product_type_name:
        description: 'Product type for auto-creation (default: Web Application)'
        required: false
        type: string
        default: 'Web Application'
      semgrep_config:
        description: 'Semgrep configuration (default: auto)'
        required: false
        type: string
        default: 'auto'
    secrets:
      DEFECTDOJO_URL:
        required: true
      DEFECTDOJO_TOKEN:
        required: true

jobs:
  semgrep:
    name: Semgrep SAST
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Semgrep
        run: pip install semgrep

      - name: Export Semgrep results
        run: |
          semgrep scan --config ${{ inputs.semgrep_config }} --json --output semgrep-results.json . || true
        continue-on-error: true

      - name: Determine product name
        id: product
        run: |
          if [ -n "${{ inputs.product_name }}" ]; then
            echo "name=${{ inputs.product_name }}" >> $GITHUB_OUTPUT
          else
            echo "name=${{ github.repository }}" >> $GITHUB_OUTPUT
          fi

      - name: Upload to DefectDojo
        if: always()
        run: |
          if [ -f semgrep-results.json ]; then
            # Use reimport-scan for deduplication - it handles both initial import
            # and updates, automatically deduplicating findings within the test
            curl -X POST "${{ secrets.DEFECTDOJO_URL }}/api/v2/reimport-scan/" \
              -H "Authorization: Token ${{ secrets.DEFECTDOJO_TOKEN }}" \
              -F "scan_type=Semgrep JSON Report" \
              -F "product_name=${{ steps.product.outputs.name }}" \
              -F "product_type_name=${{ inputs.product_type_name }}" \
              -F "engagement_name=CI/CD Scan" \
              -F "test_title=Semgrep" \
              -F "auto_create_context=true" \
              -F "verified=false" \
              -F "active=true" \
              -F "file=@semgrep-results.json" \
              -k \
              --fail-with-body || echo "Warning: Failed to upload to DefectDojo"
          else
            echo "No Semgrep results file found"
          fi

      - name: Upload results artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: semgrep-results
          path: semgrep-results.json
          retention-days: 30
          if-no-files-found: ignore
